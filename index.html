<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>éº»é›€ç‚¹æ•°è¨ˆç®— ç„¡é™ãƒ‰ãƒªãƒ«</title>
    <style>
        body {
            font-family: "Hiragino Sans", "Meiryo", sans-serif;
            background-color: #2d5a27;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        h1 {
            margin-bottom: 10px;
            font-size: 1.5rem;
            text-shadow: 1px 1px 2px #000;
        }

        .game-board {
            background-color: #1e3c1a;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            max-width: 800px;
            width: 100%;
            text-align: center;
        }

        .info-bar {
            display: flex;
            justify-content: space-around;
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .tag {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .tag-riichi {
            background: #d32f2f;
            color: white;
        }

        .tag-wind {
            background: #1976d2;
            color: white;
        }

        .tag-win-type {
            background: #fbc02d;
            color: #333;
        }

        .dora-area {
            margin: 20px 0;
            background: #222;
            padding: 10px;
            border-radius: 8px;
            display: inline-block;
        }

        .dora-label {
            font-size: 0.8rem;
            color: #aaa;
            display: block;
            margin-bottom: 5px;
        }

        .hand-area {
            display: flex;
            flex-wrap: nowrap;
            /* â†ã“ã“ã‚’ wrapâ†’nowrap ã«å¤‰æ›´ */
            justify-content: center;
            align-items: flex-end;
            gap: 5px;
            margin: 20px 0;
            min-height: 60px;
            overflow-x: auto;
            /* â† ã‚¹ãƒãƒ›ã§æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã« */
        }

        .tile {
            width: 48px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            padding: 0;
        }

        .tile img {
            width: 100%;
            height: 100%;
        }

        .tile-img {
            width: 40px;
            height: auto;
            border-radius: 4px;
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
        }

        .tile.back {
            background: #cba;
            color: transparent;
            text-shadow: none;
            width: 40px;
        }

        .tile.furo-rot {
            transform: rotate(270deg);
        }

        .furo-group {
            display: flex;
            gap: 2px;
            margin-left: 10px;
            transform: scale(0.9);
            transform-origin: bottom;
        }

        .kan-group {
            display: flex;
            gap: 2px;
            margin-left: 10px;
        }

        .controls {
            margin-top: 30px;
        }

        button {
            padding: 12px 24px;
            font-size: 1.1rem;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: 0.2s;
            font-weight: bold;
        }

        .btn-answer {
            background-color: #ff9800;
            color: #fff;
        }

        .btn-next {
            background-color: #2196f3;
            color: #fff;
            display: none;
        }

        .result-area {
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 8px;
            display: none;
            text-align: left;
            width: 100%;
            box-sizing: border-box;
        }

        .result-score {
            font-size: 2rem;
            color: #ffeb3b;
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }

        .result-detail {
            font-size: 1rem;
            line-height: 1.6;
        }

        .yaku-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
            border-top: 1px solid #555;
        }

        .yaku-item {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dotted #555;
            padding: 4px 0;
        }
    </style>
</head>

<body>
    <h1>ğŸ€„ éº»é›€ç‚¹æ•°è¨ˆç®—ãƒ‰ãƒªãƒ«</h1>
    <div class="game-board">
        <div class="info-bar">
            <span class="tag tag-wind" id="round-wind">æ±å ´</span>
            <span class="tag tag-wind" id="seat-wind">å—å®¶</span>
            <span class="tag tag-riichi" id="riichi-status" style="display:none;">ç«‹ç›´</span>
            <span class="tag tag-win-type" id="win-type">ãƒ­ãƒ³</span>
        </div>

        <div class="dora-area">
            <span class="dora-label">ãƒ‰ãƒ©è¡¨ç¤ºç‰Œï¼ˆã‚«ãƒ³ãƒ‰ãƒ©å«ã‚€ï¼‰</span>
            <div id="dora-tiles" style="display:flex; gap:5px; justify-content:center;"></div>
        </div>

        <div class="hand-area" id="hand-display"></div>

        <div class="controls">
            <button class="btn-answer" id="btn-show" onclick="app.showAnswer()">è§£ç­”ã‚’è¡¨ç¤º</button>
            <button class="btn-next" id="btn-next" onclick="app.nextProblem()">æ¬¡ã®å•é¡Œ</button>
        </div>

        <div class="result-area" id="result-box">
            <div class="result-score" id="score-display"></div>
            <div class="result-detail">
                <div><span id="fu-han-display"></span></div>
                <ul class="yaku-list" id="yaku-list"></ul>
            </div>
        </div>
    </div>

    <script>
        class MahjongQuizApp {
            constructor() {
                // Unicodeç‰Œã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆtype => index 1..9 or 1..7ï¼‰
                this.tileMap = {
                    'm': [null, 'ğŸ€‡', 'ğŸ€ˆ', 'ğŸ€‰', 'ğŸ€Š', 'ğŸ€‹', 'ğŸ€Œ', 'ğŸ€', 'ğŸ€', 'ğŸ€'],
                    'p': [null, 'ğŸ€™', 'ğŸ€š', 'ğŸ€›', 'ğŸ€œ', 'ğŸ€', 'ğŸ€', 'ğŸ€Ÿ', 'ğŸ€ ', 'ğŸ€¡'],
                    's': [null, 'ğŸ€', 'ğŸ€‘', 'ğŸ€’', 'ğŸ€“', 'ğŸ€”', 'ğŸ€•', 'ğŸ€–', 'ğŸ€—', 'ğŸ€˜'],
                    // z: 1:æ± 2:å— 3:è¥¿ 4:åŒ— 5:ç™½ 6:ç™¼ 7:ä¸­
                    'z': [null, 'ğŸ€€', 'ğŸ€', 'ğŸ€‚', 'ğŸ€ƒ', 'ğŸ€†', 'ğŸ€…', 'ğŸ€„']
                };
                this.suits = ['m', 'p', 's'];
                this.honors = [1, 2, 3, 4, 5, 6, 7];
                this.currentScenario = null;
            }

            rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

            // ãƒ‡ãƒƒã‚­ä½œæˆï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ: tileStr -> æ®‹æšæ•°ï¼‰
            initDeck() {
                const deck = {};
                this.suits.forEach(s => { for (let i = 1; i <= 9; i++) deck[s + i] = 4; });
                this.honors.forEach(n => deck['z' + n] = 4);
                return deck;
            }

            // æŒ‡å®šç‰Œã‚’ count æšå¼•ãï¼ˆdeckã‚’æ›´æ–°ï¼‰ã€‚å¤±æ•—ãªã‚‰ false
            draw(deck, tile, count) {
                if (!deck[tile] || deck[tile] < count) return false;
                deck[tile] -= count;
                return true;
            }

            // ãƒ©ãƒ³ãƒ€ãƒ ã« count æšå–ã‚Œã‚‹ã‹è©¦ã—ã€æˆåŠŸãªã‚‰ tile ã‚’è¿”ã™
            drawRandomTile(deck, predicate, count) {
                const keys = Object.keys(deck).filter(k => (!predicate || predicate(k)) && deck[k] >= count);
                if (keys.length === 0) return null;
                const t = keys[this.rand(0, keys.length - 1)];
                this.draw(deck, t, count);
                return t;
            }

            // å…¨ç‰Œãƒªã‚¹ãƒˆ
            getAllTilesList() {
                const list = [];
                this.suits.forEach(s => { for (let i = 1; i <= 9; i++) list.push(s + i); });
                this.honors.forEach(n => list.push('z' + n));
                return list;
            }

            getNextTile(tile) {
                const s = tile[0], n = parseInt(tile.slice(1));
                if (s === 'z') {
                    if (n >= 1 && n <= 4) return 'z' + (n % 4 + 1); // æ±->å—->è¥¿->åŒ—->æ±
                    if (n >= 5 && n <= 7) return 'z' + (((n - 5 + 1) % 3) + 5); // ç™½->ç™¼->ä¸­->ç™½
                }
                return s + (n % 9 + 1);
            }

            toChar(tile) {
                return `<img src="images/${this.tileToFile(tile)}.png">`;
            }

            // tileã‚³ãƒ¼ãƒ‰ â†’ ãƒ•ã‚¡ã‚¤ãƒ«å
            tileToFile(tile) {
                const suit = tile[0];
                const num = tile.slice(1);

                if (suit === 'm') return `man${num}`;
                if (suit === 'p') return `pin${num}`;
                if (suit === 's') return `sou${num}`;
                if (suit === 'z') return `zi${num}`;

                return "ura"; // ä¸‡ãŒä¸€
            }

            // --- æ‰‹ç‰Œç”Ÿæˆï¼ˆã‚ˆã‚Šå …ç‰¢ã«ï¼‰ ---
            buildHand(strategy, isMenzen) {
                // strategy: 'normal'|'tanyao'|'yakuhai'
                const deck = this.initDeck();
                const sets = [];
                let kanCount = 0;

                // å½¹ç‰Œæˆ¦ç•¥: å…ˆã«å½¹ç‰Œã®åˆ»å­ã‚’ç¢ºä¿ï¼ˆå¯èƒ½ãªã‚‰ï¼‰
                if (strategy === 'yakuhai') {
                    // ä¸‰å…ƒç‰Œã‹é¢¨ç‰Œï¼ˆå­—ç‰Œï¼‰ã‹ã‚‰ã²ã¨ã¤é¸ã¶
                    const candidate = ['z5', 'z6', 'z7']; // ä¸‰å…ƒã‚’å„ªå…ˆ
                    const pick = candidate[this.rand(0, candidate.length - 1)];
                    if (this.draw(deck, pick, 3)) {
                        sets.push({ type: 'kotsu', tiles: [pick, pick, pick], isOpen: !isMenzen && Math.random() > 0.5, isKan: false });
                    }
                }

                // é›€é ­ã‚’ç¢ºä¿ï¼ˆãƒšã‚¢ï¼‰
                const isAllowed = (t) => {
                    if (strategy === 'tanyao') {
                        if (t.startsWith('z')) return false;
                        const n = parseInt(t.slice(1));
                        return n !== 1 && n !== 9;
                    }
                    return true;
                };
                // ãƒšã‚¢ã‚’å¼•ã‘ã‚‹ã¾ã§ãƒˆãƒ©ã‚¤
                let pair = null;
                for (let tries = 0; tries < 200 && !pair; tries++) {
                    const cand = this.drawRandomTile(deck, isAllowed, 2);
                    if (cand) pair = [cand, cand];
                }
                if (!pair) return null;

                // æ®‹ã‚Šã®ãƒ¡ãƒ³ãƒ„ï¼ˆ4ã¤ã«ãªã‚‹ã‚ˆã†ã«ï¼‰
                while (sets.length < 4) {
                    // decide kotsu or shuntsu or kan
                    const pickTypeRand = Math.random();
                    if (pickTypeRand < 0.42) {
                        // åˆ»å­ç³»ï¼ˆ3 or 4æšï¼‰
                        const wantKan = Math.random() < 0.10;
                        const need = wantKan ? 4 : 3;
                        const tile = this.drawRandomTile(deck, isAllowed, need);
                        if (!tile) {
                            // try again (è»½ã„ãƒªã‚«ãƒãƒª)
                            const tile2 = this.drawRandomTile(deck, null, need);
                            if (!tile2) continue; else {
                                const isOpen = !isMenzen && (Math.random() > 0.5);
                                sets.push({ type: wantKan ? 'kan' : 'kotsu', tiles: Array(need).fill(tile2), isOpen: isOpen && !wantKan, isKan: wantKan });
                                if (wantKan) kanCount++;
                            }
                        } else {
                            const isOpen = !isMenzen && (Math.random() > 0.5);
                            sets.push({ type: wantKan ? 'kan' : 'kotsu', tiles: Array(need).fill(tile), isOpen: isOpen && !wantKan, isKan: wantKan });
                            if (wantKan) kanCount++;
                        }
                    } else {
                        // é †å­ï¼ˆå­—ç‰Œã¯ä¸å¯ï¼‰
                        const suit = this.suits[this.rand(0, 2)];
                        const start = this.rand(1, 7); // 1..7
                        const t1 = suit + start, t2 = suit + (start + 1), t3 = suit + (start + 2);
                        if (this.draw(deck, t1, 1) && this.draw(deck, t2, 1) && this.draw(deck, t3, 1)) {
                            const isOpen = !isMenzen && (Math.random() > 0.7);
                            sets.push({ type: 'shuntsu', tiles: [t1, t2, t3], isOpen, isKan: false });
                        } else {
                            // æˆ»ã—ã¯ä¸è¦ï¼ˆdrawãŒfalseãªã‚‰æ®‹æ•°ä¸è¶³ãªã®ã§åˆ¥ã‚’è©¦ã™ï¼‰
                            continue;
                        }
                    }
                }

                // ã€Œå‰¯éœ²ãƒ¢ãƒ¼ãƒ‰ã€ãªã®ã«å…¨ã¦é–‰ã˜ã¦ãŸã‚‰1ã¤é–‹ã‘ã‚‹ï¼ˆç°¡æ˜“ï¼‰
                if (!isMenzen && !sets.some(s => s.isOpen)) {
                    sets[0].isOpen = true;
                }

                // å‹ã¡ç‰Œï¼ˆå˜ç´”åŒ–ï¼šæœ€å¾Œã®ã‚»ãƒƒãƒˆã®æœ€å¾Œã®ç‰Œã‚’ä¸ŠãŒã‚Šç‰Œã¨ã™ã‚‹ï¼‰
                const lastSet = sets[sets.length - 1];
                const winTile = lastSet.tiles[lastSet.tiles.length - 1];

                return { pair, sets, kanCount, winTile, strategy, isMenzen };
            }

            // --- å½¹åˆ¤å®šï¼‹ç¬¦ï¼‹ç‚¹æ•°ï¼ˆæ”¹å–„ï¼‰ ---
            calculateScore() {
                const s = this.currentScenario;
                if (!s) return;
                let han = 0;
                let yakuList = [];
                // ã¾ãšå½¹ã®åˆ¤å®šï¼ˆç”Ÿæˆæ™‚ã®ãƒ•ãƒ©ã‚°ï¼‹å®Ÿéš›ã®ã‚»ãƒƒãƒˆï¼é›€é ­ã«åŸºã¥ãï¼‰
                if (s.isRiichi) { han += 1; yakuList.push('ç«‹ç›´'); }
                if (s.isTsumo && s.hand.isMenzen && !s.hand.sets.some(x => x.isOpen)) { han += 1; yakuList.push('é–€å‰æ¸…è‡ªæ‘¸å’Œ'); }

                // æ–­å¹ºä¹ï¼ˆtanyaoï¼‰
                if (s.hand.strategy === 'tanyao') { han += 1; yakuList.push('æ–­å¹ºä¹'); }

                // å½¹ç‰Œï¼ˆå„åˆ»å­/æ§“ã«å¯¾ã—ã¦ï¼‰
                s.hand.sets.forEach(set => {
                    if (set.type === 'kotsu' || set.type === 'kan') {
                        const t = set.tiles[0];
                        // ä¸‰å…ƒ
                        if (['z5', 'z6', 'z7'].includes(t)) {
                            han += 1; yakuList.push('å½¹ç‰Œï¼ˆ' + this.toChar(t) + 'ï¼‰');
                        }
                        // å ´é¢¨ãƒ»è‡ªé¢¨ï¼ˆå ´é¢¨ã¯ currentScenario.roundWindã€åº§é¢¨ã¯ currentScenario.seatWindï¼‰
                        if (t === s.roundWind) { han += 1; yakuList.push('å ´é¢¨ï¼ˆ' + this.toChar(t) + 'ï¼‰'); }
                        if (t === s.seatWind) { han += 1; yakuList.push('è‡ªé¢¨ï¼ˆ' + this.toChar(t) + 'ï¼‰'); }
                    }
                });

                // é›€é ­å½¹ç‰Œï¼ˆpair ãŒå½¹ç‰Œãªã‚‰åŠ ç®—ã¯ç¬¦ã®ã¿ã ãŒã€å½¹ç‰Œã®ç‚¹ã¯å½¹ä¸€ç¿»ï¼šãŸã ã—å½¹ç‰Œã¯é€šå¸¸ã€Œåˆ»å­ã€ã§1ç¿»ã€é›€é ­ã§ã¯å½¹ã«ã¯ãªã‚‰ãªã„ã€‚ â†’ é›€é ­ãŒå½¹ç‰Œãªã‚‰ç¬¦ã¯+2ã®ã¿ï¼ˆå½¹ã¨ã—ã¦ã® +1ç¿» ã¯åˆ»å­ãŒå¿…è¦ï¼‰ï¼‰
                const head = s.hand.pair[0];

                // ãƒ‰ãƒ©ï¼ˆè¡¨ç¤ºç‰Œã®æ¬¡ã®ç‰ŒãŒãƒ‰ãƒ©ã€‚æ‰‹ç‰Œä¸­ã®ãã®ç‰Œã®æšæ•°ã‚’æ•°ãˆã‚‹ï¼‰
                let doraCount = 0;
                s.doraIndicators.forEach(ind => {
                    const next = this.getNextTile(ind);
                    // æ‰‹ç‰Œå…¨ä½“ã‚’ãƒ•ãƒ©ãƒƒãƒˆåŒ–ã—ã¦æ•°ãˆã‚‹
                    const handTiles = [...s.hand.pair, ...s.hand.sets.flatMap(x => x.tiles)];
                    handTiles.forEach(t => { if (t === next) doraCount++; });
                });
                if (doraCount > 0) { han += doraCount; yakuList.push('ãƒ‰ãƒ©Ã—' + doraCount); }

                // å½¹ãŒä¸€ã¤ã‚‚ç„¡ã‘ã‚Œã°ã€Œå’Œäº†ä¸èƒ½ã€æ‰±ã„ â†’ å†ç”Ÿæˆã‚’è¡Œã†ï¼ˆå‘¼ã³å‡ºã—å…ƒã§å†ç”Ÿæˆï¼‰
                // ï¼ˆã“ã“ã§ã¯åˆ¤å®šã ã‘ã™ã‚‹ãŸã‚å¸°ã‚‹ï¼‰
                // æ¬¡ã«ç¬¦è¨ˆç®—
                let fu = 20; // åŸºæœ¬ç¬¦
                // ãƒ„ãƒ¢ï¼šå›ºå®š +2 ç¬¦ï¼ˆãƒ”ãƒ³ãƒ•ãƒ„ãƒ¢ãªã©ã®ä¾‹å¤–ã¯è€ƒæ…®ã—ãªã„ç°¡æ˜“å®Ÿè£…ï¼‰
                if (s.isTsumo) fu += 2;
                // é–€å‰ãƒ­ãƒ³ï¼š+10 ç¬¦ï¼ˆé–€å‰ã§ãƒ­ãƒ³å’Œäº†ã®å ´åˆï¼‰
                if (!s.isTsumo && s.hand.isMenzen && !s.hand.sets.some(x => x.isOpen)) fu += 10;

                // ãƒ¡ãƒ³ãƒ„ï¼ˆåˆ»å­ãƒ»æ§“ï¼‰ã®ç¬¦
                s.hand.sets.forEach(set => {
                    if (set.type === 'shuntsu') return;
                    const t = set.tiles[0];
                    const isYaochu = (t.startsWith('z') || t.endsWith('1') || t.endsWith('9'));
                    // åˆ¤å®šï¼šé–‹é–‰ã¨æ§“ã§ç¬¦å€¤ã‚’æ±ºã‚ã‚‹
                    if (set.type === 'kotsu') {
                        if (set.isOpen) {
                            // æ˜åˆ»
                            fu += isYaochu ? 4 : 2;
                        } else {
                            // æš—åˆ»
                            fu += isYaochu ? 8 : 4;
                        }
                    } else if (set.type === 'kan') {
                        // ã‚«ãƒ³ã®æ‰±ã„ï¼šæš—ã‚«ãƒ³/æ˜ã‚«ãƒ³ã§å¤‰ã‚ã‚‹
                        if (set.isOpen) {
                            // æ˜æ§“
                            fu += isYaochu ? 16 : 8;
                        } else {
                            // æš—æ§“
                            fu += isYaochu ? 32 : 16;
                        }
                    }
                });

                // é›€é ­ï¼šå ´é¢¨ãƒ»è‡ªé¢¨ãƒ»ä¸‰å…ƒç‰Œãªã‚‰ +2 ç¬¦
                if (['z5', 'z6', 'z7', s.roundWind, s.seatWind].includes(head)) {
                    fu += 2;
                }

                // å¾…ã¡ã®ç¬¦ï¼ˆã“ã“ã§ã¯ç°¡æ˜“ã«åˆ¤å®šï¼šä¸¡é¢å¾…ã¡ä»¥å¤–ã¯ +2 ç¬¦ï¼‰
                // æ­£ç¢ºã«ã¯å¾…ã¡ã‚’è§£æã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€ç°¡æ˜“åŒ–ï¼šæœ€å¾Œã®ã‚ãŒã‚Šç‰ŒãŒå«ã¾ã‚Œã‚‹ã‚»ãƒƒãƒˆã«ã‚ˆã£ã¦åˆ¤å®š
                // if waiting pattern is ä¸¡é¢ -> no extra; else +2
                // ç°¡æ˜“å®Ÿè£…: 50% ã®ç¢ºç‡ã§ +2 ï¼ˆâ€»æœ¬æ ¼å®Ÿè£…ã¯æ‰‹è§£æãŒå¿…è¦ï¼‰
                if (Math.random() > 0.5) fu += 2;

                // ç¬¦ã¯10ã®ä½ã«åˆ‡ã‚Šä¸Šã’
                fu = Math.ceil(fu / 10) * 10;
                if (fu < 20) fu = 20;

                // ç‚¹æ•°ç®—å‡ºåŸºç¤ç‚¹ï¼ˆç¬¦ Ã— 2^(ç¿»æ•°+2)ï¼‰ã¨ä¸Šé™å‡¦ç†
                // å½¹ãŒç„¡ã‘ã‚Œã° return null ã¨ã—ã¦å†ç”Ÿæˆå´ã§å†ç”Ÿæˆ
                if (han === 0) {
                    this.result = { han: 0, fu, yakuList }; // å‘¼ã³å‡ºã—å…ƒã§å‡¦ç†
                    return;
                }

                // åŸºç¤ç‚¹ã®ç®—å‡ºï¼ˆé€šå¸¸ï¼‰
                let basic = fu * Math.pow(2, han + 2);

                // æº€è²«ãƒ»è·³æº€ç­‰ã®ä¸Šé™å‡¦ç†ï¼ˆåŸºç¤ç‚¹ã‚’ç½®æ›ï¼‰
                if (han >= 13) {
                    basic = 8000; // å½¹æº€ï¼ˆåŸºç¤ç‚¹ï¼‰
                } else if (han >= 11) {
                    basic = 6000; // ä¸‰å€æº€
                } else if (han >= 8) {
                    basic = 4000; // å€æº€
                } else if (han >= 6) {
                    basic = 3000; // è·³æº€ï¼ˆ6-7ç¿»ï¼‰
                } else if (han >= 5 || (han >= 4 && fu >= 40) || (han >= 3 && fu >= 70)) {
                    basic = 2000; // æº€è²«
                } // else åŸºç¤ç‚¹ãã®ã¾ã¾

                // æ”¯æ‰•ã„è¨ˆç®—ï¼ˆåˆ‡ã‚Šä¸Šã’ã¯100ç‚¹å˜ä½ã€‚ãƒ„ãƒ¢æ”¯æ‰•ã¯è¦ª/å­ã§æ‰±ã„ãŒé•ã†ï¼‰
                let totalScore = 0;
                let payStr = '';
                if (s.isTsumo) {
                    // è¦ªãƒ„ãƒ¢ã¯å…¨å“¡æ‰•ã„ï¼ˆå­ -> è¦ªã®æ”¯æ‰•ã„ã¯ç•°ãªã‚‹ãŸã‚åŸºç¤ç‚¹*2ã‚’3äººåˆ†ï¼‰
                    if (s.isDealer) {
                        const pay = Math.ceil((basic * 2) / 100) * 100; // å„å®¶ã®æ”¯æ‰•ã„
                        totalScore = pay * 3;
                        payStr = `ãƒ„ãƒ¢ ${pay}ã‚ªãƒ¼ãƒ«`;
                    } else {
                        const dealerPay = Math.ceil((basic * 2) / 100) * 100; // è¦ªãŒæ”¯æ‰•ã†é¡
                        const nonDealerPay = Math.ceil(basic / 100) * 100; // ä»–ã®å­ãŒæ”¯æ‰•ã†é¡
                        totalScore = dealerPay + nonDealerPay * 2;
                        payStr = `ãƒ„ãƒ¢ ${nonDealerPay}/${dealerPay}`;
                    }
                } else {
                    // ãƒ­ãƒ³ï¼ˆä¸€ç™ºã§å–ã‚‹å ´åˆï¼‰: è¦ªã¯åŸºç¤ç‚¹Ã—6ã€å­ã¯åŸºç¤ç‚¹Ã—4ï¼ˆå°æ•°åˆ‡ã‚Šä¸Šã’100ï¼‰
                    const mult = s.isDealer ? 6 : 4;
                    totalScore = Math.ceil((basic * mult) / 100) * 100;
                    payStr = `${totalScore}ç‚¹`;
                }

                // ä¸Šé™åç§°
                let limitName = '';
                if (han >= 13) limitName = 'ã€å½¹æº€ã€‘';
                else if (han >= 11) limitName = 'ã€ä¸‰å€æº€ã€‘';
                else if (han >= 8) limitName = 'ã€å€æº€ã€‘';
                else if (han >= 6) limitName = 'ã€è·³æº€ã€‘';
                else if (han >= 5 || (han >= 4 && fu >= 40) || (han >= 3 && fu >= 70)) limitName = 'ã€æº€è²«ã€‘';

                this.result = { fu, han, yakuList, totalScore, payStr, limitName };
            }

            // --- ã‚·ãƒŠãƒªã‚ªç”Ÿæˆï¼ˆå½¹ãªã—ã¯ãƒªãƒˆãƒ©ã‚¤ï¼‰ ---
            generateScenario() {
                // try generating until we get a hand with at least one yaku (å½¹) or reasonable attempts
                for (let tries = 0; tries < 200; tries++) {
                    const isDealer = Math.random() > 0.75;
                    const roundWind = Math.random() > 0.5 ? 'z1' : 'z2'; // æ± or å—å ´
                    // seatWind: è¦ªã¯ z1ï¼ˆæ±ï¼‰ã€å­ã¯ z2..z4 ã®ã„ãšã‚Œã‹
                    const seatWind = isDealer ? 'z1' : ['z2', 'z3', 'z4'][this.rand(0, 2)];
                    const isTsumo = Math.random() > 0.5;
                    const isMenzen = Math.random() > 0.4;
                    const isRiichi = isMenzen && Math.random() > 0.3;

                    let strategy = isMenzen ? 'normal' : (Math.random() > 0.5 ? 'tanyao' : 'yakuhai');

                    const handData = this.buildHand(strategy, isMenzen);
                    if (!handData) continue;

                    // ãƒ‰ãƒ©è¡¨ç¤ºï¼ˆã‚«ãƒ³æ•°è€ƒæ…®ã—ã¦ 1 + kanCount è¡¨ç¤ºï¼‰
                    const allTiles = this.getAllTilesList();
                    const doraIndicators = [];
                    const deckForDora = this.initDeck(); // ç°¡æ˜“ï¼šãƒ‰ãƒ©ã¯ãƒ©ãƒ³ãƒ€ãƒ é¸æŠï¼ˆæœ¬æ¥ã¯ãƒ„ãƒ¢å±±ã®æ®‹ã‚Šé †ï¼‰
                    for (let i = 0; i < 1 + handData.kanCount; i++) {
                        doraIndicators.push(allTiles[this.rand(0, allTiles.length - 1)]);
                    }

                    this.currentScenario = {
                        isDealer, roundWind, seatWind, isTsumo, isRiichi,
                        hand: handData,
                        doraIndicators,
                        winTile: handData.winTile
                    };

                    // è¨ˆç®—
                    this.calculateScore();
                    // å½¹ãŒç„¡ã‘ã‚Œã°å†ç”Ÿæˆ
                    if (!this.result || (this.result.han === 0)) {
                        continue;
                    }
                    // æˆåŠŸ
                    this.renderUI();
                    return;
                }
                // å¤±æ•—ã—ãŸå ´åˆã¯å¿µã®ãŸã‚å†å¸°ï¼ˆç¨€ï¼‰
                console.warn('scenario generate failed - retrying');
                this.generateScenario();
            }

            // --- UIæç”» ---
            renderUI() {
                const s = this.currentScenario;
                document.getElementById('round-wind').textContent = (s.roundWind === 'z1' ? 'æ±' : 'å—') + 'å ´';
                document.getElementById('seat-wind').textContent = s.isDealer ? 'è¦ª(æ±å®¶)' : (s.seatWind === 'z2' ? 'å—å®¶' : (s.seatWind === 'z3' ? 'è¥¿å®¶' : 'åŒ—å®¶'));
                document.getElementById('riichi-status').style.display = s.isRiichi ? 'inline' : 'none';
                document.getElementById('win-type').textContent = s.isTsumo ? 'ãƒ„ãƒ¢' : 'ãƒ­ãƒ³';

                // ãƒ‰ãƒ©è¡¨ç¤º
                const doraContainer = document.getElementById('dora-tiles');
                doraContainer.innerHTML = '';
                s.doraIndicators.forEach(t => {
                    const img = document.createElement('img');
                    img.className = 'tile-img';
                    img.src = `images/${this.toImgFile(t)}`;
                    doraContainer.appendChild(img);
                });

                // æ‰‹ç‰Œè¡¨ç¤ºï¼ˆç°¡ç•¥ï¼špair -> é–‰ã˜ã‚»ãƒƒãƒˆ -> é–‹æ”¾ã‚»ãƒƒãƒˆï¼‰
                const handContainer = document.getElementById('hand-display');
                handContainer.innerHTML = '';
                s.hand.pair.forEach(t => this.addTileToHand(handContainer, t));
                s.hand.sets.filter(set => !set.isOpen).forEach(set =>
                    set.tiles.forEach(t => this.addTileToHand(handContainer, t))
                );
                // é–‹æ”¾ã‚»ãƒƒãƒˆã¯å³å´ã«ã‚°ãƒ«ãƒ¼ãƒ—ã§è¡¨ç¤º
                const openSets = s.hand.sets.filter(set => set.isOpen);
                openSets.forEach(set => {
                    const group = document.createElement('div');
                    group.className = set.type === 'kan' ? 'kan-group' : 'furo-group';

                    set.tiles.forEach(t => {
                        const img = document.createElement('img');
                        img.className = 'tile-img';
                        img.src = `images/${this.toImgFile(t)}`;
                        group.appendChild(img);
                    });

                    handContainer.appendChild(group);
                });

                document.getElementById('result-box').style.display = 'none';
                document.getElementById('btn-show').style.display = 'inline-block';
                document.getElementById('btn-next').style.display = 'none';
            }

            toImgFile(tile) {
                const suit = tile[0];       // m, p, s, z
                const num = tile.slice(1);  // 1ã€œ9 or 1ã€œ7
                return `${suit}${num}.png`;
            }

            addTileToHand(container, tile) {
                const img = document.createElement('img');
                img.className = 'tile-img';
                img.src = `images/${this.toImgFile(tile)}`;
                container.appendChild(img);
            }


            showAnswer() {
                const r = this.result;
                if (!r) return;
                const scoreBox = document.getElementById('score-display');
                scoreBox.textContent = `${r.limitName} ${r.totalScore}ç‚¹ (${r.payStr})`;
                const fuHanBox = document.getElementById('fu-han-display');
                fuHanBox.textContent = `${r.fu}ç¬¦ ${r.han}ç¿»`;
                const list = document.getElementById('yaku-list');
                list.innerHTML = '';
                r.yakuList.forEach(y => {
                    const li = document.createElement('li');
                    li.className = 'yaku-item';
                    li.innerHTML = `<span>${y}</span>`;
                    list.appendChild(li);
                });
                document.getElementById('result-box').style.display = 'block';
                document.getElementById('btn-show').style.display = 'none';
                document.getElementById('btn-next').style.display = 'inline-block';
            }

            nextProblem() {
                this.generateScenario();
            }
        }

        const app = new MahjongQuizApp();
        app.generateScenario();

    </script>
</body>

</html>